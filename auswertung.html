<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Auswertung – Letzte korrekte · Chronologie · Fehlversuche · Themen · Verteilung · Extra-Charts</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#93a4c7;--text:#e8eeff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0f1530 100%);color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:18px 22px;border-bottom:1px solid #1f2a4d;background:rgba(11,16,32,.8);backdrop-filter:blur(6px)}
    h1{font-size:18px;margin:0}
    .meta{font-size:12px;color:var(--muted)}
    main{padding:22px;max-width:1200px;margin:0 auto;display:grid;gap:18px}
    .card{background:#121a33;border:1px solid #1f2a4d;border-radius:14px;padding:16px}
    .table{width:100%;border-collapse:collapse;border:1px solid #1f2a4d;border-radius:12px;overflow:hidden}
    .table th,.table td{border-bottom:1px solid #1f2a4d;padding:8px 10px;text-align:left;font-size:13px}
    .table th{background:#0f1731;color:var(--muted);font-weight:600}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #2a3869;border-radius:999px;font-size:11px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{background:#0f1731;color:var(--text);border:1px solid #2a3869;border-radius:10px;padding:8px 10px}
    .pill{border:1px solid #2a3869;border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}
    ol.tasks{margin:0;padding-left:1.2rem}
    ol.tasks li{margin:6px 0}
    .small{font-size:12px;color:var(--muted)}
    .right{text-align:right}
    .center{text-align:center}
    .foot{background:#0f1731;font-weight:600}
    .chart-wrap{background:#0f1731;border:1px solid #1f2a4d;border-radius:12px;padding:12px}
    canvas{max-width:100%; display:block;}
  </style>
</head>
<body>
<header>
<svg aria-hidden="true" fill="none" height="22" stroke="#6ea8fe" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="22"><path d="M21 15V6a2 2 0 0 0-2-2h-7"></path><path d="M3 9v9a2 2 0 0 0 2 2h7"></path><path d="M3 9l7-7"></path><path d="M21 15l-7 7"></path></svg>
<div>
<h1>Auswertung – Letzte korrekte Antworten &amp; Aufgabenfolge</h1>
<div class="meta">Zeitraum A: <b>14.05.2025, 08:45–10:00</b> · Zeitraum B: <b>21.05.2025, 08:40–09:15</b> · Schüler: <span class="badge">schueler-1 … schueler-26</span></div>
</div>
</header>
<main>
<!-- A: Letzte korrekte 14.05 -->
<!-- A2: Letzte korrekte 21.05 -->
<!-- B: Chronologie 14.05 -->
<!-- B2: Chronologie 21.05 -->
<!-- C: Fehlversuche 14.05 -->
<!-- C2: Fehlversuche 21.05 -->
<!-- D: Ø Fehlversuche pro Thema (14.05) -->
<!-- E: Verteilung letzte korrekte (14.05) -->
<!-- E2: Verteilung letzte korrekte (21.05) -->
<!-- F2: Drei neue Charts (21.05) -->
<section class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row"><strong>Fortschritt (kompakt) – 14.05</strong></div>
    <div class="small muted" id="activeInfo"></div>
    <div class="row">
      <label class="small" for="studentSel">Schüler (14.05):</label>
      <select id="studentSel"></select>
    </div>
  </div>

  <div style="overflow:auto;border:1px solid #1f2a4d;border-radius:12px;margin-top:10px">
    <table class="table" id="tbl-progress-compact-14">
      <thead>
        <tr>
          <th class="right">Fortschritt</th>
          <th class="right">Anzahl Schüler</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="foot">
          <td class="right">Aktive Schüler</td>
          <td class="right" id="activeCount14">0</td>
        </tr>
      </tfoot>
    </table>
  </div>
</section>



</section><section class="card">
<div class="row" style="justify-content:space-between">
<div class="row"><strong>Fehlversuche pro Aufgabe (14.05)</strong></div>
<div class="small muted">Basis: Aufgabenfolge des gewählten Schülers (14.05)</div>
</div>
<div style="overflow:auto;border:1px solid #1f2a4d;border-radius:12px;margin-top:10px">
<table class="table" id="tbl-errors">
<thead><tr><th class="center">#</th><th>Aufgabe – Vorschau</th><th class="right">Fehlversuche</th></tr></thead>
<tbody></tbody>
<tfoot><tr class="foot"><td class="right" colspan="2">Summe</td><td class="right" id="sumErrors">0</td></tr></tfoot>
</table>
</div>
</section><section class="card">
<div class="row" style="justify-content:space-between">
<div class="row"><strong>Durchschnittliche Fehlversuche pro Thema</strong><span class="pill">x: Themen · y: Ø Fehlversuche (14.05)</span></div>
</div>
<div class="chart-wrap"><canvas height="260" id="topicChart"></canvas></div>
</section>

<section class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row"><strong>Fortschritt (kompakt) – 21.05</strong></div>
    <div class="small muted" id="activeInfo21"></div>
    <div class="row">
      <label class="small" for="studentSel21">Schüler (21.05):</label>
      <select id="studentSel21"></select>
    </div>
  </div>

  <div style="overflow:auto;border:1px solid #1f2a4d;border-radius:12px;margin-top:10px">
    <table class="table" id="tbl-progress-compact-21">
      <thead>
        <tr>
          <th class="right">Fortschritt</th>
          <th class="right">Anzahl Schüler</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="foot">
          <td class="right">Aktive Schüler</td>
          <td class="right" id="activeCount21">0</td>
        </tr>
      </tfoot>
    </table>
  </div>
</section>

<section class="card">
<div class="row" style="justify-content:space-between">
<div class="row"><strong>Fehlversuche pro Aufgabe (21.05)</strong></div>
<div class="small muted">Basis: Aufgabenfolge des gewählten Schülers (21.05)</div>
</div>
<div style="overflow:auto;border:1px solid #1f2a4d;border-radius:12px;margin-top:10px">
<table class="table" id="tbl-errors-21">
<thead><tr><th class="center">#</th><th>Aufgabe – Vorschau</th><th class="right">Fehlversuche</th></tr></thead>
<tbody></tbody>
<tfoot><tr class="foot"><td class="right" colspan="2">Summe</td><td class="right" id="sumErrors21">0</td></tr></tfoot>
</table>
</div>
</section><section class="card">
<div class="row" style="justify-content:space-between">
<div class="row"><strong>Ø Falschantworten (21.05)</strong><span class="pill">Indikativ (1–20) vs. Subjonctif (21–57)</span></div>
<div class="small muted">Reihenfolge der Aufgaben wird aus der längsten Schülersequenz im Zeitraum abgeleitet.</div>
</div>
<div class="chart-wrap"><canvas height="220" id="chart21_mode"></canvas></div>
</section><section class="card">
<div class="row" style="justify-content:space-between">
<div class="row"><strong>Ø Falschantworten (21.05)</strong><span class="pill">Indikativ (1–20): regelmäßig vs. unregelmäßig</span></div>
<div class="small muted">Heuristik: Aufgaben 10–13 = unregelmäßig (être, devoir, faire), übrige 1–20 = regelmäßig.</div>
</div>
<div class="chart-wrap"><canvas height="220" id="chart21_reg_irreg"></canvas></div>
</section><section class="card">
<div class="row" style="justify-content:space-between">
<div class="row"><strong>Ø Falschantworten (21.05)</strong><span class="pill">Indikativ (1–20): nach Subjektpronomen</span></div>
<div class="small muted">Nur Pronomen anzeigen, die im Aufgaben­text vorkommen.</div>
</div>
<div class="chart-wrap"><canvas height="220" id="chart21_pronouns"></canvas></div>
</section><section style="display:none"><h2>Hidden 14.05 (compat)</h2><table id="tbl-last-true"><tbody></tbody></table><ul id="taskList"></ul></section><section style="display:none"><h2>Hidden 21.05 (compat)</h2><table id="tbl-last-true-21"><tbody></tbody></table><ul id="taskList21"></ul></section></main>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const TOTAL_TASKS_14 = 32;
  const TOTAL_TASKS_21 = 57;
  // ===== Firebase Init =====
  const firebaseConfig = {
    apiKey: "AIzaSyB-_wWnWQp4ErY0bNEgZFbxsA9gCm0OJek",
    authDomain: "e-learning-francais.firebaseapp.com",
    projectId: "e-learning-francais",
    storageBucket: "e-learning-francais.appspot.com",
    messagingSenderId: "806897329547",
    appId: "1:806897329547:web:9852a0b728381264f4fb8e",
    measurementId: "G-793SPC6M7Q"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== Parameter =====
  const STUDENTS = Array.from({length:26}, (_,i)=>`schueler-${i+1}`);
  const STUDENTS_SET = new Set(STUDENTS);
  const start = new Date('2025-05-14T08:45:00+02:00');
  const end   = new Date('2025-05-14T10:00:00+02:00');
  const start2 = new Date('2025-05-21T08:40:00+02:00');
  const end2   = new Date('2025-05-21T09:15:00+02:00');

  function toJSDate(ts){
    if(ts && typeof ts.toDate === 'function') return ts.toDate();
    if(ts && typeof ts.seconds === 'number') return new Date(ts.seconds*1000);
    if(typeof ts === 'string') return new Date(ts);
    return new Date(ts||Date.now());
  }

  function textPreview(html){
    const div = document.createElement('div');
    div.innerHTML = String(html||'');
    return (div.textContent||'').replace(/\s+/g,' ').trim().slice(0,140);
  }

  function normalizeTask(html){
    const div = document.createElement('div');
    div.innerHTML = String(html||'');
    return (div.textContent||'').replace(/\s+/g,' ').trim();
  }

  // ===== Caches 14.05 =====
  let _allDocs = [];
  let _latest = new Map();
  let _activeStudents = new Set();

  // ===== Caches 21.05 =====
  let _allDocs21 = [];
  let _latest21 = new Map();
  let _activeStudents21 = new Set();

  // -------------------- 14.05 Lauf --------------------
  async function run(){
    const tbody = document.querySelector('#tbl-last-true tbody');
    const studentSel = document.getElementById('studentSel');
    const taskList = document.getElementById('taskList');
    tbody.innerHTML = ''; studentSel.innerHTML=''; taskList.innerHTML='';

    const snap = await db.collection('antworten')
      .where('timestamp', '>=', start)
      .where('timestamp', '<=', end)
      .get();

    _allDocs = [];
    _latest = new Map();
    _activeStudents = new Set();

    snap.forEach(doc=>{
      const d = doc.data(); if(!d) return;
      const id = d.schuelerId || d.SchuelerID || d.schuelerID || '';
      if(!STUDENTS_SET.has(id)) return;
      _activeStudents.add(id);

      const ts = toJSDate(d.timestamp);
      const korrekt = d.korrekt === true;
      const key = normalizeTask(d.aufgabe);

      const rec = { id, ts, korrekt, aufgabe: d.aufgabe, antwort: d.antwort, key };
      _allDocs.push(rec);

      if(korrekt){
        const cur = _latest.get(id);
        if(!cur || ts > cur.ts){
          _latest.set(id, { ts, preview: textPreview(d.aufgabe), answer: d.antwort, key });
        }
      }
    });

    // Tabelle A
    STUDENTS.forEach(id=>{
      const tr = document.createElement('tr');
      const rec = _latest.get(id);
      if(rec){
        tr.innerHTML = `<td>${id}</td><td class="nowrap">${rec.ts.toLocaleString()}</td><td>${rec.preview}…</td><td>${String(rec.answer||'')}</td>`;
      } else {
        tr.innerHTML = `<td>${id}</td><td colspan="3" class="muted">— keine korrekte Antwort im Zeitraum gefunden —</td>`;
      }
      tbody.appendChild(tr);
    });

    // Dropdown 14.05
    const candidates = Array.from(_latest.keys());
    if(candidates.length === 0){
      const opt = document.createElement('option'); opt.value = ''; opt.textContent = '— keine Kandidaten —';
      studentSel.appendChild(opt);
    } else {
      let preferred = candidates.includes('schueler-3') ? 'schueler-3'
                    : candidates.includes('schueler-2') ? 'schueler-2'
                    : candidates[0];
      candidates.sort((a,b)=> parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]))
        .forEach(id=>{
          const rec = _latest.get(id);
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = rec ? `${id} – letzte korrekte: ${rec.ts.toLocaleTimeString()}` : id;
          if(id === preferred) opt.selected = true;
          studentSel.appendChild(opt);
        });
      renderAll(preferred);
      studentSel.addEventListener('change', (e)=> renderAll(e.target.value));
    }
  }

  // -------------------- 21.05 Lauf --------------------
  async function runSecond(){
    const tbody2 = document.querySelector('#tbl-last-true-21 tbody');
    const studentSel21 = document.getElementById('studentSel21');
    const taskList21 = document.getElementById('taskList21');
    tbody2.innerHTML = ''; studentSel21.innerHTML = ''; taskList21.innerHTML = '';

    const snap2 = await db.collection('antworten')
      .where('timestamp', '>=', start2)
      .where('timestamp', '<=', end2)
      .get();

    _allDocs21 = [];
    _latest21 = new Map();
    _activeStudents21 = new Set();

    const latestByStudent = new Map();

    snap2.forEach(doc=>{
      const d = doc.data(); if(!d) return;
      const id = d.schuelerId || d.SchuelerID || d.schuelerID || '';
      if(!STUDENTS_SET.has(id)) return;
      _activeStudents21.add(id);

      const ts = toJSDate(d.timestamp);
      const korrekt = d.korrekt === true;
      const key = normalizeTask(d.aufgabe);
      const rec = { id, ts, korrekt, aufgabe: d.aufgabe, antwort: d.antwort, key };
      _allDocs21.push(rec);

      if(korrekt){
        const cur = latestByStudent.get(id);
        if(!cur || ts > cur.ts){
          latestByStudent.set(id, { ts, preview: textPreview(d.aufgabe), answer: d.antwort, key });
        }
      }
    });

    // Tabelle A2
    STUDENTS.forEach(id=>{
      const tr = document.createElement('tr');
      const rec = latestByStudent.get(id);
      if(rec){
        tr.innerHTML = `<td>${id}</td><td class="nowrap">${rec.ts.toLocaleString()}</td><td>${rec.preview}…</td><td>${String(rec.answer||'')}</td>`;
      } else {
        tr.innerHTML = `<td>${id}</td><td colspan="3" class="muted">— keine korrekte Antwort im Zeitraum gefunden —</td>`;
      }
      tbody2.appendChild(tr);
    });

    _latest21 = latestByStudent;

    // Dropdown 21.05
    const candidates21 = Array.from(_latest21.keys());
    if(candidates21.length === 0){
      const opt = document.createElement('option'); opt.value = ''; opt.textContent = '— keine Kandidaten —';
      studentSel21.appendChild(opt);
    } else {
      let preferred21 = candidates21.includes('schueler-3') ? 'schueler-3'
                      : candidates21.includes('schueler-2') ? 'schueler-2'
                      : candidates21[0];
      candidates21.sort((a,b)=> parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]))
        .forEach(id=>{
          const rec = _latest21.get(id);
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = rec ? `${id} – letzte korrekte: ${rec.ts.toLocaleTimeString()}` : id;
          if(id === preferred21) opt.selected = true;
          studentSel21.appendChild(opt);
        });
      renderAll21(preferred21);
      studentSel21.addEventListener('change', (e)=> { renderAll21(e.target.value); renderCharts21(); });
    }

    // Charts (21.05) nach Laden der Daten
    renderCharts21();
  }

  // ---------- Render Helpers 14.05 ----------
function renderAll(studentId){
  renderSequence(studentId);
  renderErrorsForCurrentSequence(studentId);
  renderTopicChart(studentId);
  // ALT: renderLastTrueDistribution(studentId);
  renderProgressCompact14(); // NEU
}
  function getUniqueCorrectTasksFor(studentId){
    const items = _allDocs.filter(r => r.id === studentId && r.korrekt).sort((a,b)=> a.ts - b.ts);
    const seen = new Set(); const uniqueTasks = [];
    for(const it of items){
      const key = it.key; if(!key || seen.has(key)) continue;
      seen.add(key);
      uniqueTasks.push({ key, ts: it.ts, preview: textPreview(it.aufgabe) });
    }
    return uniqueTasks;
  }

  function renderSequence(studentId){
    const taskList = document.getElementById('taskList');
    taskList.innerHTML = ''; if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor(studentId);
    if(uniqueTasks.length === 0){
      const li = document.createElement('li'); li.className = 'muted'; li.textContent = 'Keine korrekten Antworten im Zeitraum.'; taskList.appendChild(li); return;
    }
    uniqueTasks.forEach((it, idx)=>{
      const li = document.createElement('li');
      li.innerHTML = `<strong>Aufgabe ${idx+1}:</strong> ${it.preview}… <span class="small">(um ${it.ts.toLocaleTimeString()})</span>`;
      taskList.appendChild(li);
    });
  }

  function renderErrorsForCurrentSequence(studentId){
    const tbody = document.querySelector('#tbl-errors tbody'); const sumEl = document.getElementById('sumErrors');
    tbody.innerHTML = ''; sumEl.textContent = '0'; if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor(studentId);
    if(uniqueTasks.length === 0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="3" class="center muted">Keine Aufgabenbasis.</td>`; tbody.appendChild(tr); return; }
    const counts = new Map(); for(const rec of _allDocs){ if(rec.korrekt === false){ counts.set(rec.key, (counts.get(rec.key)||0)+1); } }
    let sum = 0;
    uniqueTasks.forEach((task, idx)=>{
      const c = counts.get(task.key) || 0; sum += c;
      const tr = document.createElement('tr'); tr.innerHTML = `<td class="center">${idx+1}</td><td>${task.preview}…</td><td class="right">${c}</td>`; tbody.appendChild(tr);
    });
    sumEl.textContent = String(sum);
  }

  function renderTopicChart(studentId){
    const ctx = document.getElementById('topicChart').getContext('2d');
    if(window._topicChart){ window._topicChart.destroy(); }
    if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor(studentId);
    if(uniqueTasks.length === 0) return;
    const counts = new Map(); for(const rec of _allDocs){ if(rec.korrekt === false){ counts.set(rec.key, (counts.get(rec.key)||0)+1); } }
    const mapping = {
      "Adjektive": [1,2,3,4,5,29,30],
      "adorer/aimer/préférer/détester + Artikel": [6,7,8,9,10,11,12,13,31,32],
      "aller à vs en": [14,15,16,17,18,19,26],
      "jouer à vs de": [20,21,22,23,24,25,27,28]
    };
    const labels = [], data = [];
    for(const [theme, nums] of Object.entries(mapping)){
      let sum=0, n=0;
      nums.forEach(num=>{
        const task = uniqueTasks[num-1];
        if(task){ const c = counts.get(task.key) || 0; sum += c; n++; }
      });
      labels.push(theme); data.push(n>0 ? +(sum/n).toFixed(2) : 0);
    }
    window._topicChart = new Chart(ctx, {
      type:'bar', data:{ labels, datasets:[{label:'Ø Fehlversuche', data, barPercentage:0.5, categoryPercentage:0.6}]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true,title:{display:true,text:'Ø Fehlversuche'},ticks:{precision:0},grid:{color:'rgba(255,255,255,0.12)'}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} }
    });
  }

  function renderLastTrueDistribution(studentId){
    const tbody = document.querySelector('#tbl-lasttrue-per-task tbody');
    const sumCountEl = document.getElementById('sumLastTrueCount');
    const sumPctEl = document.getElementById('sumLastTruePct');
    const activeInfo = document.getElementById('activeInfo');
    tbody.innerHTML = ''; sumCountEl.textContent='0'; sumPctEl.textContent='—';
    const activeCount = _activeStudents.size; activeInfo.textContent = `Aktive Schüler (14.05): ${activeCount}`;
    if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor(studentId);
    if(uniqueTasks.length === 0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="4" class="center muted">Keine Aufgabenbasis.</td>`; tbody.appendChild(tr); return; }
    const indexByKey = new Map(); uniqueTasks.forEach((t, idx)=> indexByKey.set(t.key, idx+1));
    const counts = new Array(uniqueTasks.length).fill(0);
    for(const id of _activeStudents){
      const rec = _latest.get(id);
      if(rec && indexByKey.has(rec.key)){ counts[indexByKey.get(rec.key)-1] += 1; }
    }
    let sum=0;
    counts.forEach((c,i)=>{
      const pct = activeCount ? ((c/activeCount)*100) : 0; sum += c;
      const tr = document.createElement('tr'); tr.innerHTML = `<td class="center">${i+1}</td><td>${uniqueTasks[i].preview}…</td><td class="right">${c}</td><td class="right">${pct.toFixed(1)}%</td>`; tbody.appendChild(tr);
    });
    sumCountEl.textContent = String(sum);
    sumPctEl.textContent = activeCount ? `${((sum/activeCount)*100).toFixed(1)}%` : '—';
  }
  // längste einmalige (korrekte) Aufgabenfolge im Zeitraum 14.05
function buildLongestSequenceKeys14(){
  let best = [];
  for (const id of _activeStudents) {
    const seq = getUniqueCorrectTasksFor(id); // existiert bereits
    if (seq.length > best.length) best = seq;
  }
  return best.map(t => t.key); // Array von keys in Reihenfolge
}

// Kompakte Tabelle: "x % : y Schüler" (14.05)
function renderProgressCompact14(){
  const tbody = document.querySelector('#tbl-progress-compact-14 tbody');
  const activeInfo = document.getElementById('activeInfo');
  const activeCountEl = document.getElementById('activeCount14');
  tbody.innerHTML = '';

  const activeCount = _activeStudents.size;
  activeInfo.textContent = `Aktive Schüler (14.05): ${activeCount}`;
  activeCountEl.textContent = String(activeCount);

  // Index-Abbildung per längster Schüler-Sequenz
  const longestKeys = buildLongestSequenceKeys14();
  const indexByKey = new Map(longestKeys.map((k, i) => [k, i + 1])); // 1..N

  // letzte korrekte pro Schüler -> Index zählen
  const countsByIndex = new Map();
  for (const id of _activeStudents) {
    const rec = _latest.get(id);          // wird in run() befüllt
    if (!rec) continue;
    const num = indexByKey.get(rec.key);  // Position der letzten Aufgabe
    if (!num) continue;                   // Task kommt evtl. nicht in longestKeys vor
    countsByIndex.set(num, (countsByIndex.get(num) || 0) + 1);
  }

  // Zeilen: Prozent = floor( num / 32 * 100 ), nur Indizes mit >=1 Schüler
  const rows = Array.from(countsByIndex.entries())
    .map(([num, cnt]) => ({ pct: Math.floor((num / TOTAL_TASKS_14) * 100), cnt }))
    .sort((a, b) => b.pct - a.pct);

  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="2" class="center small">Keine Endstationen im Zeitraum.</td></tr>`;
    return;
  }

  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="right">${r.pct} %</td><td class="right">${r.cnt} Schüler</td>`;
    tbody.appendChild(tr);
  }
}

  // ---------- Render Helpers 21.05 ----------
function renderAll21(studentId){
  renderSequence21(studentId);
  renderErrorsForCurrentSequence21(studentId);
  // ALT: renderLastTrueDistribution21(studentId);
  renderProgressCompact21(); // NEU
}


  function getUniqueCorrectTasksFor21(studentId){
    const items = _allDocs21.filter(r => r.id === studentId && r.korrekt).sort((a,b)=> a.ts - b.ts);
    const seen = new Set(); const uniqueTasks = [];
    for(const it of items){
      const key = it.key; if(!key || seen.has(key)) continue;
      seen.add(key);
      uniqueTasks.push({ key, ts: it.ts, preview: textPreview(it.aufgabe) });
    }
    return uniqueTasks;
  }

  function renderSequence21(studentId){
    const taskList = document.getElementById('taskList21');
    taskList.innerHTML = ''; if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor21(studentId);
    if(uniqueTasks.length === 0){ const li = document.createElement('li'); li.className='muted'; li.textContent='Keine korrekten Antworten im Zeitraum.'; taskList.appendChild(li); return; }
    uniqueTasks.forEach((it, idx)=>{
      const li = document.createElement('li');
      li.innerHTML = `<strong>Aufgabe ${idx+1}:</strong> ${it.preview}… <span class="small">(um ${it.ts.toLocaleTimeString()})</span>`;
      taskList.appendChild(li);
    });
  }

  function renderErrorsForCurrentSequence21(studentId){
    const tbody = document.querySelector('#tbl-errors-21 tbody'); const sumEl = document.getElementById('sumErrors21');
    tbody.innerHTML = ''; sumEl.textContent = '0'; if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor21(studentId);
    if(uniqueTasks.length === 0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="3" class="center muted">Keine Aufgabenbasis.</td>`; tbody.appendChild(tr); return; }
    const counts = new Map(); for(const rec of _allDocs21){ if(rec.korrekt === false){ counts.set(rec.key, (counts.get(rec.key)||0)+1); } }
    let sum = 0;
    uniqueTasks.forEach((task, idx)=>{
      const c = counts.get(task.key) || 0; sum += c;
      const tr = document.createElement('tr'); tr.innerHTML = `<td class="center">${idx+1}</td><td>${task.preview}…</td><td class="right">${c}</td>`; tbody.appendChild(tr);
    });
    sumEl.textContent = String(sum);
  }

  function renderLastTrueDistribution21(studentId){
    const tbody = document.querySelector('#tbl-lasttrue-per-task-21 tbody');
    const sumCountEl = document.getElementById('sumLastTrueCount21');
    const sumPctEl = document.getElementById('sumLastTruePct21');
    const activeInfo = document.getElementById('activeInfo21');
    tbody.innerHTML = ''; sumCountEl.textContent='0'; sumPctEl.textContent='—';
    const activeCount = _activeStudents21.size; activeInfo.textContent = `Aktive Schüler (21.05): ${activeCount}`;
    if(!studentId) return;
    const uniqueTasks = getUniqueCorrectTasksFor21(studentId);
    if(uniqueTasks.length === 0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="4" class="center muted">Keine Aufgabenbasis.</td>`; tbody.appendChild(tr); return; }
    const indexByKey = new Map(); uniqueTasks.forEach((t, idx)=> indexByKey.set(t.key, idx+1));
    const counts = new Array(uniqueTasks.length).fill(0);
    for(const id of _activeStudents21){
      const rec = _latest21.get(id);
      if(rec && indexByKey.has(rec.key)){ counts[indexByKey.get(rec.key)-1] += 1; }
    }
    let sum=0;
    counts.forEach((c,i)=>{
      const pct = activeCount ? ((c/activeCount)*100) : 0; sum += c;
      const tr = document.createElement('tr'); tr.innerHTML = `<td class="center">${i+1}</td><td>${uniqueTasks[i].preview}…</td><td class="right">${c}</td><td class="right">${pct.toFixed(1)}%</td>`; tbody.appendChild(tr);
    });
    sumCountEl.textContent = String(sum);
    sumPctEl.textContent = activeCount ? `${((sum/activeCount)*100).toFixed(1)}%` : '—';
  }
  // längste einmalige (korrekte) Aufgabenfolge im Zeitraum 21.05
function buildLongestSequenceKeys21(){
  let best = [];
  for (const id of _activeStudents21) {
    const seq = getUniqueCorrectTasksFor21(id);
    if (seq.length > best.length) best = seq;
  }
  return best.map(t => t.key); // Array von keys in Reihenfolge
}

// Kompakte Tabelle: "x % : y Schüler" (21.05)
function renderProgressCompact21(){
  const tbody = document.querySelector('#tbl-progress-compact-21 tbody');
  const activeInfo = document.getElementById('activeInfo21');
  const activeCountEl = document.getElementById('activeCount21');
  tbody.innerHTML = '';

  const activeCount = _activeStudents21.size;
  activeInfo.textContent = `Aktive Schüler (21.05): ${activeCount}`;
  activeCountEl.textContent = String(activeCount);

  // Index-Abbildung per längster Schüler-Sequenz (liefert 1..N)
  const longestKeys = buildLongestSequenceKeys21();
  const indexByKey = new Map(longestKeys.map((k, i) => [k, i + 1]));

  // letzte korrekte pro Schüler -> Index zählen
  const countsByIndex = new Map();
  for (const id of _activeStudents21) {
    const rec = _latest21.get(id);     // in runSecond() befüllt
    if (!rec) continue;
    const num = indexByKey.get(rec.key);
    if (!num) continue;                 // falls Task nicht in longestKeys
    countsByIndex.set(num, (countsByIndex.get(num) || 0) + 1);
  }

  // Prozent = floor( num / 57 * 100 ), nur Einträge mit >= 1 Schüler
  const rows = Array.from(countsByIndex.entries())
    .map(([num, cnt]) => ({ pct: Math.floor((num / TOTAL_TASKS_21) * 100), cnt }))
    .sort((a, b) => b.pct - a.pct);

  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="2" class="center small">Keine Endstationen im Zeitraum.</td></tr>`;
    return;
  }

  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="right">${r.pct} %</td><td class="right">${r.cnt} Schüler</td>`;
    tbody.appendChild(tr);
  }
}


  // ===== Zusatz-Utilities & Charts (21.05) =====
  function buildFalseCountsByKey21(){
    const counts = new Map();
    for(const rec of _allDocs21){
      if(rec.korrekt === false){
        counts.set(rec.key, (counts.get(rec.key)||0)+1);
      }
    }
    return counts;
  }

  function averageFalseForNumbers(numberSet, numberByKey, falseByKey){
    let sum = 0;
    const seenNumbers = new Set();
    for(const [key, num] of numberByKey.entries()){
      if(numberSet.has(num)){
        const c = falseByKey.get(key) || 0;
        sum += c;
        seenNumbers.add(num);
      }
    }
    const nTasks = seenNumbers.size;
    return nTasks > 0 ? sum / nTasks : 0;
  }

  function detectPronounFromText(text){
    const t = String(text||'').toLowerCase();
    if(/ils?\s*\/\s*elles/.test(t) || /(\bils\b|\belles\b)/.test(t)) return "ils/elles";
    if(/il\s*\/\s*elle\s*\/\s*on/.test(t) || /il\/elle\/on/.test(t) || /\bil\b|\belle\b|\bon\b/.test(t)) return "il/elle/on";
    if(/\bnous\b/.test(t)) return "nous";
    if(/\bvous\b/.test(t)) return "vous";
    if(/\bje\b/.test(t)) return "je";
    if(/\btu\b/.test(t)) return "tu";
    return null;
  }

  function buildReferenceNumbering21(){
    const students = Array.from(_activeStudents21);
    let bestSeq = [];
    for(const id of students){
      const seq = getUniqueCorrectTasksFor21(id);
      if(seq.length > bestSeq.length){
        bestSeq = seq;
      }
    }
    const map = new Map();
    bestSeq.forEach((t, idx)=> map.set(t.key, idx+1));
    return map;
  }

  function buildPronounAverages21(numberByKey, falseByKey){
    const buckets = new Map(); // pronoun -> {sum, nums:Set}
    for(const [key, num] of numberByKey.entries()){
      if(num>=1 && num<=20){
        const pron = detectPronounFromText(key);
        const c = falseByKey.get(key) || 0;
        if(pron){
          if(!buckets.has(pron)) buckets.set(pron, {sum:0, nums:new Set()});
          const obj = buckets.get(pron);
          obj.sum += c;
          obj.nums.add(num);
        }
      }
    }
    const labels = [], data = [];
    for(const [p, obj] of buckets.entries()){
      const avg = obj.nums.size > 0 ? obj.sum / obj.nums.size : 0;
      labels.push(p); data.push(+avg.toFixed(2));
    }
    return {labels, data};
  }

  function renderCharts21(){
    if(window._chart21_mode){ window._chart21_mode.destroy(); }
    if(window._chart21_regirreg){ window._chart21_regirreg.destroy(); }
    if(window._chart21_pron){ window._chart21_pron.destroy(); }

    const numberByKey = buildReferenceNumbering21();
    const falseByKey = buildFalseCountsByKey21();

    const indicSet = new Set(Array.from({length:20}, (_,i)=> i+1));
    const subjSet   = new Set(Array.from({length:37}, (_,i)=> i+21)); // 21..57
    const avgIndic = averageFalseForNumbers(indicSet, numberByKey, falseByKey);
    const avgSubj  = averageFalseForNumbers(subjSet,   numberByKey, falseByKey);

    const ctx1 = document.getElementById('chart21_mode').getContext('2d');
    window._chart21_mode = new Chart(ctx1, {
      type:'bar',
      data:{ labels:['Indikativ (1–20)','Subjonctif (21–57)'], datasets:[{label:'Ø Fehlversuche', data:[+avgIndic.toFixed(2), +avgSubj.toFixed(2)], barPercentage:0.5, categoryPercentage:0.6}]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true,title:{display:true,text:'Ø Falschantworten'}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} }
    });

    const irregular = new Set([10,11,12,13]);
    const regular = new Set([...Array.from({length:20},(_,i)=>i+1)].filter(n=> !irregular.has(n)));
    const avgReg = averageFalseForNumbers(regular, numberByKey, falseByKey);
    const avgIrreg = averageFalseForNumbers(irregular, numberByKey, falseByKey);

    const ctx2 = document.getElementById('chart21_reg_irreg').getContext('2d');
    window._chart21_regirreg = new Chart(ctx2, {
      type:'bar',
      data:{ labels:['regelmäßig','unregelmäßig'], datasets:[{label:'Ø Fehlversuche', data:[+avgReg.toFixed(2), +avgIrreg.toFixed(2)], barPercentage:0.5, categoryPercentage:0.6}]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true,title:{display:true,text:'Ø Falschantworten'}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} }
    });

    const pr = buildPronounAverages21(numberByKey, falseByKey);
    const ctx3 = document.getElementById('chart21_pronouns').getContext('2d');
    window._chart21_pron = new Chart(ctx3, {
      type:'bar',
      data:{ labels: pr.labels, datasets:[{label:'Ø Fehlversuche', data: pr.data, barPercentage:0.5, categoryPercentage:0.6}]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true,title:{display:true,text:'Ø Falschantworten'}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} }
    });
  }

  // Start
  run().catch(console.error);
  runSecond().catch(console.error);
  </script>
</body>
</html>
